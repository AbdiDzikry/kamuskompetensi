import React, { useState, useRef, useEffect } from 'react';
import { Search, BookOpen, Youtube, Briefcase, ChevronRight, CheckCircle, Brain, Target, Star, ArrowLeft, MessageSquare, Send, Loader2, Sparkles, AlertCircle, HelpCircle, GraduationCap, X, Check, Calendar } from 'lucide-react';

// --- KONFIGURASI API ---
// Di lingkungan preview ini, apiKey akan terisi otomatis.
// Untuk Vercel: Gunakan import.meta.env.VITE_GEMINI_API_KEY
const apiKey = ""; 

// --- HELPER: GEMINI API CALLS ---
const generateContent = async (prompt) => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            responseMimeType: "application/json"
          }
        }),
      }
    );

    if (!response.ok) throw new Error("Gagal menghubungi AI");
    
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    return JSON.parse(text);
  } catch (error) {
    console.error("API Error:", error);
    throw error;
  }
};

const generateChatResponse = async (history, context, question) => {
  try {
    const contextPrompt = `
      Context Data Kompetensi: ${JSON.stringify(context)}
      Peran kamu adalah Karir Coach senior. Jawablah pertanyaan user berdasarkan data kompetensi di atas.
      Jawab dengan ringkas, memotivasi, dan praktis. Gunakan Bahasa Indonesia.
    `;

    const contents = [
      { role: "user", parts: [{ text: contextPrompt }] },
      ...history.map(msg => ({
        role: msg.sender === 'user' ? 'user' : 'model',
        parts: [{ text: msg.text }]
      })),
      { role: "user", parts: [{ text: question }] }
    ];

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents }),
      }
    );

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, saya tidak dapat memproses pertanyaan.";
  } catch (error) {
    return "Terjadi kesalahan saat menghubungi AI.";
  }
};

// --- KOMPONEN UTAMA ---

export default function App() {
  // Main State
  const [searchTerm, setSearchTerm] = useState("");
  const [jobData, setJobData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [view, setView] = useState("home"); // 'home', 'detail'
  
  // Chat State
  const [chatHistory, setChatHistory] = useState([]);
  const [chatInput, setChatInput] = useState("");
  const [chatLoading, setChatLoading] = useState(false);
  const chatEndRef = useRef(null);

  // New Feature State: Quiz & Roadmap
  const [activeModal, setActiveModal] = useState(null); // 'quiz' | 'roadmap' | null
  const [modalData, setModalData] = useState(null);
  const [modalLoading, setModalLoading] = useState(false);
  const [quizAnswer, setQuizAnswer] = useState(null); // index of selected answer

  // Auto scroll chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatHistory]);

  // Handler: Cari Kompetensi
  const handleSearch = async (e) => {
    e.preventDefault();
    if (!searchTerm.trim()) return;

    setLoading(true);
    setError(null);
    setJobData(null);
    setChatHistory([]);

    const prompt = `
      Buatkan "Kamus Kompetensi" lengkap untuk posisi pekerjaan: "${searchTerm}".
      
      Output HARUS dalam format JSON dengan struktur persis seperti ini:
      {
        "title": "${searchTerm}",
        "description": "Deskripsi singkat tentang peran ini (maks 2 kalimat).",
        "levels": {
          "Basic": [
            { "name": "Nama Skill", "desc": "Penjelasan skill", "search_keyword": "Keyword spesifik untuk mencari materi belajar skill ini" }
          ],
          "Intermediate": [ ... ],
          "Expert": [ ... ]
        }
      }
      
      Aturan:
      1. Berikan minimal 3 skill per level.
      2. Campurkan Hard Skill dan Soft Skill.
      3. Pastikan search_keyword sangat spesifik.
      4. Gunakan Bahasa Indonesia.
    `;

    try {
      const result = await generateContent(prompt);
      setJobData(result);
      setView("detail");
    } catch (err) {
      setError("Gagal menghasilkan data. Pastikan API Key valid atau coba lagi nanti.");
    } finally {
      setLoading(false);
    }
  };

  // Handler: Generate Quiz
  const handleGenerateQuiz = async (skillName) => {
    setActiveModal('quiz');
    setModalLoading(true);
    setModalData(null);
    setQuizAnswer(null);

    const prompt = `
      Buatkan 1 soal pilihan ganda (4 opsi) untuk menguji pemahaman tentang skill "${skillName}" 
      untuk posisi "${jobData.title}".
      
      Format JSON: 
      { 
        "skill": "${skillName}",
        "question": "Pertanyaan...", 
        "options": ["Opsi A", "Opsi B", "Opsi C", "Opsi D"], 
        "correctIndex": 0, // index 0-3
        "explanation": "Penjelasan singkat kenapa jawabannya benar." 
      }
    `;

    try {
      const result = await generateContent(prompt);
      setModalData(result);
    } catch (err) {
      setError("Gagal membuat kuis.");
      setActiveModal(null);
    } finally {
      setModalLoading(false);
    }
  };

  // Handler: Generate Roadmap
  const handleGenerateRoadmap = async (level) => {
    setActiveModal('roadmap');
    setModalLoading(true);
    setModalData(null);

    const prompt = `
      Buatkan roadmap belajar 4 minggu untuk mencapai level "${level}" pada posisi "${jobData.title}".
      
      Format JSON: 
      { 
        "level": "${level}",
        "weeks": [
          { "week": 1, "focus": "Fokus minggu ini", "tasks": ["Tugas 1", "Tugas 2", "Tugas 3"] },
          { "week": 2, "focus": "...", "tasks": [...] },
          { "week": 3, "focus": "...", "tasks": [...] },
          { "week": 4, "focus": "...", "tasks": [...] }
        ]
      }
    `;

    try {
      const result = await generateContent(prompt);
      setModalData(result);
    } catch (err) {
      setError("Gagal membuat roadmap.");
      setActiveModal(null);
    } finally {
      setModalLoading(false);
    }
  };

  // Handler: Kirim Chat
  const handleSendChat = async (e) => {
    e.preventDefault();
    if (!chatInput.trim()) return;

    const userMsg = chatInput;
    setChatInput("");
    setChatHistory(prev => [...prev, { sender: 'user', text: userMsg }]);
    setChatLoading(true);

    const reply = await generateChatResponse(chatHistory, jobData, userMsg);
    
    setChatHistory(prev => [...prev, { sender: 'ai', text: reply }]);
    setChatLoading(false);
  };

  const handleBack = () => {
    setView("home");
    setChatHistory([]);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
      
      {/* HEADER */}
      <header className="bg-gradient-to-r from-indigo-600 to-purple-700 text-white shadow-lg sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center space-x-2 cursor-pointer" onClick={handleBack}>
            <Brain className="w-8 h-8 text-yellow-300" />
            <div className="leading-tight">
              <h1 className="text-xl font-bold tracking-tight">Kamus Kompetensi AI</h1>
              <p className="text-xs text-indigo-200">Konsep by Pak Luthfi</p>
            </div>
          </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="flex-grow container mx-auto px-4 py-8 relative">
        
        {/* VIEW: HOME / SEARCH */}
        {view === "home" && (
          <div className="flex flex-col items-center justify-center min-h-[60vh] max-w-2xl mx-auto text-center animate-fadeIn">
            <div className="mb-8 p-4 bg-indigo-50 rounded-full inline-block">
              <Sparkles className="w-12 h-12 text-indigo-600" />
            </div>
            
            <h2 className="text-4xl font-extrabold mb-4 text-slate-900">
              Cari Standar Kompetensi <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Pekerjaan Apapun</span>
            </h2>
            
            <p className="text-slate-500 mb-8 text-lg">
              Generate roadmap skill, kuis interaktif, dan panduan belajar dari level Basic hingga Expert dalam hitungan detik.
            </p>

            <form onSubmit={handleSearch} className="w-full relative group">
              <input
                type="text"
                className="w-full pl-6 pr-14 py-5 rounded-2xl border-2 border-slate-200 shadow-xl text-lg focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                placeholder="Contoh: AI Engineer, Barista, CEO Startup..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                disabled={loading}
              />
              <button 
                type="submit" 
                disabled={loading || !searchTerm}
                className="absolute right-3 top-3 bottom-3 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition-colors disabled:bg-slate-300"
              >
                {loading ? <Loader2 className="animate-spin w-6 h-6" /> : <Search className="w-6 h-6" />}
              </button>
            </form>

            <div className="mt-8 flex flex-wrap justify-center gap-2">
              <span className="text-sm text-slate-400">Populer:</span>
              {["Full Stack Developer", "Content Creator", "HR Manager", "Data Scientist"].map(job => (
                <button 
                  key={job}
                  onClick={() => { setSearchTerm(job); }}
                  className="text-sm px-3 py-1 bg-white border border-slate-200 rounded-full text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors"
                >
                  {job}
                </button>
              ))}
            </div>

            {error && (
              <div className="mt-6 p-4 bg-red-50 text-red-600 rounded-lg flex items-center gap-2">
                <AlertCircle className="w-5 h-5" />
                {error}
              </div>
            )}
          </div>
        )}

        {/* VIEW: DETAIL RESULT */}
        {view === "detail" && jobData && (
          <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 animate-slideUp">
            
            {/* Left Column: Job Info & Content */}
            <div className="lg:col-span-2 space-y-8">
              {/* Job Header */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <button onClick={handleBack} className="text-sm text-slate-500 hover:text-indigo-600 flex items-center gap-1 mb-4">
                  <ArrowLeft className="w-4 h-4" /> Kembali ke pencarian
                </button>
                <div className="flex items-start justify-between">
                  <div>
                    <h2 className="text-3xl font-bold text-slate-900 mb-2">{jobData.title}</h2>
                    <p className="text-slate-600 leading-relaxed">{jobData.description}</p>
                  </div>
                  <div className="bg-indigo-50 p-3 rounded-xl hidden sm:block">
                    <Briefcase className="w-8 h-8 text-indigo-600" />
                  </div>
                </div>
              </div>

              {/* Levels Tabs/Sections */}
              {['Basic', 'Intermediate', 'Expert'].map((level) => (
                <div key={level} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                  <div className={`px-6 py-4 border-b border-slate-100 flex items-center justify-between
                    ${level === 'Basic' ? 'bg-green-50/50' : level === 'Intermediate' ? 'bg-blue-50/50' : 'bg-purple-50/50'}`}>
                    <div className="flex items-center gap-3">
                      {level === 'Basic' && <CheckCircle className="w-5 h-5 text-green-600" />}
                      {level === 'Intermediate' && <Target className="w-5 h-5 text-blue-600" />}
                      {level === 'Expert' && <Star className="w-5 h-5 text-purple-600" />}
                      <h3 className="font-bold text-lg text-slate-800">Level {level}</h3>
                    </div>
                    
                    {/* BUTTON: Generate Roadmap */}
                    <button 
                      onClick={() => handleGenerateRoadmap(level)}
                      className="flex items-center gap-2 text-xs font-semibold bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-full hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm"
                    >
                      <Calendar className="w-3.5 h-3.5" />
                      Buat Roadmap
                    </button>
                  </div>
                  
                  <div className="divide-y divide-slate-50">
                    {jobData.levels[level]?.map((skill, idx) => (
                      <div key={idx} className="p-6 hover:bg-slate-50 transition-colors group">
                        <div className="flex justify-between items-start mb-2">
                          <h4 className="font-semibold text-slate-900 text-lg">{skill.name}</h4>
                          <div className="flex gap-2">
                             {/* BUTTON: Quiz */}
                            <button
                              onClick={() => handleGenerateQuiz(skill.name)}
                              className="flex items-center gap-1.5 text-xs font-semibold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-100 transition-colors"
                              title="Tes pemahamanmu tentang skill ini"
                            >
                              <HelpCircle className="w-3.5 h-3.5" />
                              Tes Skill
                            </button>
                          </div>
                        </div>
                        <p className="text-slate-600 mb-4 text-sm">{skill.desc}</p>
                        
                        <div className="flex gap-3">
                          <a 
                            href={`https://www.google.com/search?q=${encodeURIComponent(skill.search_keyword + " article guide")}`} 
                            target="_blank" 
                            rel="noreferrer"
                            className="flex items-center gap-1.5 text-xs font-medium text-slate-500 hover:text-blue-600 transition-colors"
                          >
                            <BookOpen className="w-3.5 h-3.5" /> Baca Artikel
                          </a>
                          <a 
                            href={`https://www.youtube.com/results?search_query=${encodeURIComponent(skill.search_keyword + " tutorial")}`} 
                            target="_blank" 
                            rel="noreferrer"
                            className="flex items-center gap-1.5 text-xs font-medium text-slate-500 hover:text-red-600 transition-colors"
                          >
                            <Youtube className="w-3.5 h-3.5" /> Tonton Video
                          </a>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            {/* Right Column: Chat Assistant (Sticky) */}
            <div className="lg:col-span-1">
              <div className="sticky top-24 bg-white rounded-2xl shadow-xl border border-indigo-100 overflow-hidden flex flex-col h-[calc(100vh-120px)] max-h-[600px]">
                <div className="bg-indigo-600 p-4 text-white flex items-center gap-2">
                  <MessageSquare className="w-5 h-5" />
                  <h3 className="font-bold">Coach AI Assistant</h3>
                </div>
                
                {/* Chat History */}
                <div className="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50">
                  {chatHistory.length === 0 && (
                    <div className="text-center text-slate-400 text-sm py-8 px-4">
                      <p>Bingung dengan salah satu skill? Tanyakan di sini!</p>
                      <p className="mt-2 text-xs bg-white p-2 rounded border border-slate-200 inline-block">
                        "Apa projek pemula untuk belajar {jobData.levels.Basic[0]?.name}?"
                      </p>
                    </div>
                  )}
                  {chatHistory.map((msg, i) => (
                    <div key={i} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] rounded-2xl p-3 text-sm ${
                        msg.sender === 'user' 
                          ? 'bg-indigo-600 text-white rounded-br-none' 
                          : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none shadow-sm'
                      }`}>
                        {msg.text}
                      </div>
                    </div>
                  ))}
                  {chatLoading && (
                    <div className="flex justify-start">
                      <div className="bg-white border border-slate-200 p-3 rounded-2xl rounded-bl-none shadow-sm">
                        <Loader2 className="w-4 h-4 animate-spin text-indigo-600" />
                      </div>
                    </div>
                  )}
                  <div ref={chatEndRef} />
                </div>

                {/* Chat Input */}
                <form onSubmit={handleSendChat} className="p-3 bg-white border-t border-slate-100">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="Tanya Coach..."
                      className="w-full pl-4 pr-12 py-3 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                      value={chatInput}
                      onChange={(e) => setChatInput(e.target.value)}
                      disabled={chatLoading}
                    />
                    <button 
                      type="submit"
                      disabled={chatLoading || !chatInput.trim()}
                      className="absolute right-2 top-2 p-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-slate-300 transition-colors"
                    >
                      <Send className="w-4 h-4" />
                    </button>
                  </div>
                </form>
              </div>
            </div>

          </div>
        )}

        {/* --- MODALS --- */}
        
        {/* MODAL OVERLAY */}
        {activeModal && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
              
              {/* Modal Header */}
              <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                  {activeModal === 'quiz' ? <HelpCircle className="w-5 h-5 text-indigo-600" /> : <GraduationCap className="w-5 h-5 text-indigo-600" />}
                  {activeModal === 'quiz' ? 'Tes Pemahaman Skill' : 'Roadmap Belajar'}
                </h3>
                <button 
                  onClick={() => setActiveModal(null)}
                  className="p-1 hover:bg-slate-200 rounded-full transition-colors"
                >
                  <X className="w-5 h-5 text-slate-500" />
                </button>
              </div>

              {/* Modal Content */}
              <div className="p-6 overflow-y-auto">
                {modalLoading ? (
                  <div className="flex flex-col items-center justify-center py-12 text-slate-500">
                    <Loader2 className="w-8 h-8 animate-spin text-indigo-600 mb-3" />
                    <p>Sedang meminta materi dari AI...</p>
                  </div>
                ) : modalData ? (
                  <>
                    {/* QUIZ CONTENT */}
                    {activeModal === 'quiz' && (
                      <div>
                        <span className="text-xs font-semibold text-indigo-600 bg-indigo-50 px-2 py-1 rounded mb-3 inline-block">
                          {modalData.skill}
                        </span>
                        <h4 className="text-lg font-medium text-slate-900 mb-6">{modalData.question}</h4>
                        
                        <div className="space-y-3">
                          {modalData.options.map((opt, idx) => (
                            <button
                              key={idx}
                              onClick={() => setQuizAnswer(idx)}
                              disabled={quizAnswer !== null}
                              className={`w-full text-left p-4 rounded-xl border transition-all ${
                                quizAnswer === null 
                                  ? 'border-slate-200 hover:border-indigo-400 hover:bg-indigo-50' 
                                  : quizAnswer === idx 
                                    ? idx === modalData.correctIndex 
                                      ? 'border-green-500 bg-green-50 ring-2 ring-green-500/20' 
                                      : 'border-red-300 bg-red-50'
                                    : idx === modalData.correctIndex
                                      ? 'border-green-500 bg-green-50'
                                      : 'border-slate-100 text-slate-400'
                              }`}
                            >
                              <div className="flex items-center gap-3">
                                <div className={`w-6 h-6 rounded-full border flex items-center justify-center text-xs font-bold ${
                                  quizAnswer === idx 
                                    ? idx === modalData.correctIndex ? 'bg-green-500 text-white border-green-500' : 'bg-red-500 text-white border-red-500'
                                    : 'border-slate-300 text-slate-500'
                                }`}>
                                  {String.fromCharCode(65 + idx)}
                                </div>
                                <span>{opt}</span>
                                {quizAnswer !== null && idx === modalData.correctIndex && <Check className="w-5 h-5 text-green-600 ml-auto" />}
                              </div>
                            </button>
                          ))}
                        </div>

                        {quizAnswer !== null && (
                          <div className={`mt-6 p-4 rounded-xl border ${quizAnswer === modalData.correctIndex ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                            <p className={`font-bold mb-1 ${quizAnswer === modalData.correctIndex ? 'text-green-800' : 'text-red-800'}`}>
                              {quizAnswer === modalData.correctIndex ? "Benar! ðŸŽ‰" : "Kurang Tepat."}
                            </p>
                            <p className="text-sm text-slate-700">{modalData.explanation}</p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* ROADMAP CONTENT */}
                    {activeModal === 'roadmap' && (
                      <div>
                         <div className="mb-4">
                            <h4 className="text-xl font-bold text-slate-900">Roadmap Level {modalData.level}</h4>
                            <p className="text-sm text-slate-500">Rencana belajar intensif 4 minggu</p>
                         </div>
                         <div className="space-y-6 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px before:h-full before:w-0.5 before:bg-gradient-to-b before:from-indigo-600 before:via-slate-300 before:to-transparent">
                            {modalData.weeks.map((weekData, idx) => (
                              <div key={idx} className="relative flex items-start pl-12 group">
                                <div className="absolute left-0 top-1 w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg ring-4 ring-white">
                                  W{weekData.week}
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 w-full group-hover:border-indigo-200 transition-colors">
                                  <h5 className="font-bold text-indigo-700 mb-2">{weekData.focus}</h5>
                                  <ul className="space-y-2">
                                    {weekData.tasks.map((task, tIdx) => (
                                      <li key={tIdx} className="flex items-start gap-2 text-sm text-slate-600">
                                        <div className="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5 shrink-0" />
                                        {task}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              </div>
                            ))}
                         </div>
                      </div>
                    )}
                  </>
                ) : (
                  <div className="text-center text-red-500 py-8">Gagal memuat data. Silakan coba lagi.</div>
                )}
              </div>
            </div>
          </div>
        )}

      </main>
    </div>
  );
}